<div>
    <script src="https://unpkg.com/@vkid/sdk@<3.0.0/dist-sdk/umd/index.js"></script>
    <script type="text/javascript">

        function getCookie(name) {
            const matches = document.cookie.match(new RegExp(`(?:^|; )${name}=([^;]*)`));
            return matches ? decodeURIComponent(matches[1]) : undefined;
        }

        const mainElement = document.currentScript.parentElement

        fetch("https://92.255.165.189/VKID/GetNewLoginTokens", {
            method: 'POST',
            credentials: 'include' // Отправлять cookie с запросом
        })
            .then((response) => {
                if (!response.ok) {
                    throw new Error(`HTTP err: ${response.status}`);
                }
                return response.json();
            })
            .then((data) => {
                if (data.state) {
                    const stateValue = data.state;

                    InitVKIDOneClick(data.state, data.codeChallenge)
                }
            })
            .catch((error) => {
                console.error("err:", error);
            });

        function InitVKIDOneClick(state, codeChallenge) {

            if ('VKIDSDK' in window) {
                const VKID = window.VKIDSDK;

                VKID.Config.init({
                    app: 51919588,
                    redirectUrl: 'https://byadminpresents.github.io/TestVKService/',
                    responseMode: VKID.ConfigResponseMode.Callback,
                    source: VKID.ConfigSource.LOWCODE,
                    scope: '',
                    codeChallenge,
                    state
                });

                const floatingOneTap = new VKID.FloatingOneTap();

                floatingOneTap.render({
                    scheme: 'dark',
                    appName: 'TestApp',
                     showAlternativeLogin: true
                    })
                    .on(VKID.WidgetEvents.ERROR, vkidOnError)
                    .on(VKID.FloatingOneTapInternalEvents.LOGIN_SUCCESS, function (payload) {
                        const code = payload.code;
                        const deviceId = payload.device_id;
                        
                        fetch("https://92.255.165.189/VKID/PerformVKIDLogin?code=" + code + "&deviceId=" + deviceId, {
                            method: 'POST',
                            credentials: 'include' // Отправлять cookie с запросом
                        })
                            .then((response) => {
                                if (!response.ok) {
                                    throw new Error(`HTTP err: ${response.status}`);
                                }
                                return response.json();
                            })
                            .then((data) => {
                                console.log(data)
                            })
                            .catch((error) => {
                                console.error("err:", error);
                            });

                        sendPostRequest(code, deviceId, state)
                    });
            }
        }

        function vkidOnError(error) {
            console.log(error)
        }

    </script>
</div>
