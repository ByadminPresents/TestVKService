<div>
    <script src="https://unpkg.com/@vkid/sdk@<3.0.0/dist-sdk/umd/index.js"></script>
    <script type="text/javascript">

        function getCookie(name) {
            const matches = document.cookie.match(new RegExp(`(?:^|; )${name}=([^;]*)`));
            return matches ? decodeURIComponent(matches[1]) : undefined;
        }

        // let url = "http://92.255.165.189:8082/VKID/GetNewLoginTokens"

        // let state = getCookie("state")

        // if (state) {
        //     url += "?state=" + state;
        // }

        fetch("https://92.255.165.189:59917/VKID/GetNewLoginTokens", {
                method: 'POST',
                credentials: 'same-origin' // Отправлять cookie с запросом
            })
            .then((response) => {
                if (!response.ok) {
                    throw new Error(`HTTP err: ${response.status}`);
                }
                return response.json();
            })
            .then((data) => {
                if (data.state) {
                    const stateValue = data.state;

                    document.cookie = 'state=' + stateValue + '; path=/; max-age=3600;';

                    InitVKIDOneClick(state, codeChallenge)
                }
            })
            .catch((error) => {
                console.error("err:", error);
            });

        function InitVKIDOneClick(state, codeChallenge) {

            if ('VKIDSDK' in window) {
                const VKID = window.VKIDSDK;

                VKID.Config.init({
                    app: 51919588,
                    redirectUrl: 'https://byadminpresents.github.io/TestVKService/',
                    responseMode: VKID.ConfigResponseMode.Callback,
                    source: VKID.ConfigSource.LOWCODE,
                    scope: '',
                    codeChallenge,
                    state
                });

                const oneTap = new VKID.OneTap();

                oneTap.render({
                    container: document.currentScript.parentElement,
                    showAlternativeLogin: true
                })
                    .on(VKID.WidgetEvents.ERROR, vkidOnError)
                    .on(VKID.OneTapInternalEvents.LOGIN_SUCCESS, function (payload) {
                        const code = payload.code;
                        const deviceId = payload.device_id;

                        sendPostRequest(code, deviceId, state)
                    });
            }
        }

    </script>
</div>
